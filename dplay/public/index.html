<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DPlay WhatsApp Bot</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(to right, #1c1c1c, #282828);
      color: #fff;
      font-family: 'Arial', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 20px;
    }
    .container {
      max-width: 700px;
      width: 100%;
      background-color: #222;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
    }
    h1 { text-align: center; margin-bottom: 20px; }
    .flow-step { margin-bottom: 15px; }
    #qrCode { text-align: center; margin-bottom: 20px; }
    button { width: 100%; }
    .btn-add-step { margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>DPlay WhatsApp Bot</h1>

    <!-- QR Code -->
    <div id="qrCode">
      <button class="btn btn-warning" onclick="startBot()">Gerar QR Code</button>
      <p id="qrStatus"></p>
      <img id="qrImg" src="" alt="" style="max-width: 250px; margin-top: 10px; display: none;">
    </div>

    <!-- Fluxo de atendimento -->
    <h4>Fluxo de atendimento</h4>
    <div id="flowContainer"></div>
    <button class="btn btn-success btn-add-step" onclick="addStep()">Adicionar etapa</button>

    <button class="btn btn-primary mt-3" onclick="saveFlow()">Salvar Fluxo</button>

    <!-- Envio manual -->
    <h4 class="mt-4">Enviar mensagem manual</h4>
    <input class="form-control mb-2" id="numberInput" placeholder="Número (ex: 5511999999999)">
    <textarea class="form-control mb-2" id="messageInput" placeholder="Mensagem"></textarea>
    <button class="btn btn-info" onclick="sendMessageManual()">Enviar</button>
    <p id="sendStatus"></p>
  </div>

  <script>
    let flow = [];

    function startBot() {
      fetch('/start')
        .then(res => res.text())
        .then(msg => {
          document.getElementById('qrStatus').innerText = msg;
          // Aqui você pode criar uma rota /qr no backend para exibir QR code como imagem
        })
        .catch(err => console.error(err));
    }

    function addStep() {
      const stepIndex = flow.length;
      flow.push({ message: '', response: '' });

      const stepDiv = document.createElement('div');
      stepDiv.classList.add('flow-step', 'p-2', 'border', 'border-secondary', 'rounded');
      stepDiv.id = `step-${stepIndex}`;
      stepDiv.innerHTML = `
        <label>Mensagem do bot:</label>
        <input class="form-control mb-1" oninput="updateStep(${stepIndex}, 'message', this.value)">
        <label>Resposta do usuário:</label>
        <input class="form-control" oninput="updateStep(${stepIndex}, 'response', this.value)">
      `;

      document.getElementById('flowContainer').appendChild(stepDiv);
    }

    function updateStep(index, field, value) {
      flow[index][field] = value;
    }

    function saveFlow() {
      fetch('/save-flow', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ flow })
      })
      .then(res => res.text())
      .then(msg => alert(msg))
      .catch(err => console.error(err));
    }

    function sendMessageManual() {
      const number = document.getElementById('numberInput').value;
      const message = document.getElementById('messageInput').value;

      fetch('/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ number, message })
      })
      .then(res => res.text())
      .then(msg => {
        document.getElementById('sendStatus').innerText = msg;
      })
      .catch(err => {
        document.getElementById('sendStatus').innerText = 'Erro ao enviar mensagem';
        console.error(err);
      });
    }
  </script>
</body>
</html>
